docker-swapi: 
	docker run -d -p 27017-27019:27017-27019 --name swapi mongo

docker-stop:
	docker stop swapi

docker-rm:
	docker rm swapi

docker-clean: docker-stop docker-rm

install-json-to-go:
	curl "https://raw.githubusercontent.com/areThereAnyUserNamesLeft/json-to-go/master/json-to-go.js" --output "json-to-go.js" ; 
	sed -i "s/function jsonToGo(json, typename, flatten = true)/function jsonToGo(json, typename, flatten = false)/g" "json-to-go.js"; \

fetch-models:
	for V in films people planets species starships vehicles ; do \
	curl "https://raw.githubusercontent.com/areThereAnyUserNamesLeft/swapi/master/resources/schemas/$$V.json" --output "models/json/$$V.json" ; \
	done;  

clean-models:
	rm -f models/json/*.json
	rm -f models/structs/*.go  

convert-models:
	for V in films people planets species starships vehicles ; do \
	echo "package structs" > "models/structs/$$V.go"; \
	cat "models/json/$$V.json" | node json-to-go.js >> "models/structs/$$V.go"; \
	sed -i "s/AutoGenerated/\u$$V/g" "models/structs/$$V.go"; \
	sed -ri 's/`json:"(.*)"`/`json:"\1" bson:"\1"`/'  "models/structs/$$V.go"; \
	go fmt "models/structs/$$V.go"; \
	done; \

refresh-models: clean-models fetch-models convert-models

fetch-data:
	for V in films people planets species starships vehicles ; do \
	curl "https://raw.githubusercontent.com/areThereAnyUserNamesLeft/swapi/master/resources/fixtures/$$V.json" --output "database/data/$$V.json" ; \
	done; \

convert-data:
	for V in films people planets species starships vehicles ; do \
	echo -e 'package structs\n import "time"' > "database/structs/$$V.go"; \
	cat "database/data/$$V.json" | node json-to-go.js >> "database/structs/$$V.go"; \
	sed -i "s/AutoGenerated/\u$$V/g" "database/structs/$$V.go"; \
	sed -ri 's/`json:"(.*)"`/`json:"\1" bson:"\1"`/'  "database/structs/$$V.go"; \
	go fmt "database/structs/$$V.go"; \
	done; \

clean-time:
	sed -i 's/import "time"//g' "database/structs/vehicles.go"; \
	sed -i 's/import "time"//g' "database/structs/starships.go"; \
	go fmt "database/structs/vehicles.go" "database/structs/starships.go" \

clean-data:
	rm -f database/data/*.json
	rm -f database/structs/*.go

refresh-data: clean-data fetch-data convert-data clean-time

run:
	go run main.go

refresh-run: refresh-models refresh-data run

clean-restart: refresh-models refresh-data docker-clean docker-swapi run
 
